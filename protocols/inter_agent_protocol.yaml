# VAK Inter-Agent Communication Protocol
# Defines how agents communicate with each other and the kernel

version: "1.0.0"
protocol_name: "VAK-IPC"

# =============================================================================
# PROTOCOL OVERVIEW
# =============================================================================

overview:
  description: |
    The VAK Inter-Agent Communication Protocol (VAK-IPC) defines standardized
    message formats and routing rules for all communication within the kernel.
    
    All messages pass through the kernel - no direct agent-to-agent communication.
    This ensures policy enforcement and audit logging for every interaction.

  principles:
    - "Kernel-mediated: All messages route through kernel"
    - "Typed messages: Strict schema validation"
    - "Async-first: Non-blocking by default"
    - "Auditable: Every message logged"
    - "Authenticated: Sender identity verified"

# =============================================================================
# MESSAGE ENVELOPE
# =============================================================================

message_envelope:
  description: "Standard wrapper for all VAK messages"
  
  schema:
    type: "object"
    required:
      - message_id
      - timestamp
      - sender
      - message_type
      - payload
    properties:
      message_id:
        type: "string"
        format: "uuid"
        description: "Unique identifier for this message"
      
      timestamp:
        type: "string"
        format: "date-time"
        description: "ISO 8601 timestamp when message was created"
      
      sender:
        type: "object"
        properties:
          agent_id:
            type: "string"
          agent_role:
            type: "string"
          session_id:
            type: "string"
        required: ["agent_id", "agent_role"]
      
      recipient:
        type: "object"
        description: "Optional - for targeted messages"
        properties:
          agent_id:
            type: "string"
          broadcast:
            type: "boolean"
            description: "If true, message goes to all agents"
      
      message_type:
        type: "string"
        enum:
          - "tool_request"
          - "tool_response"
          - "policy_query"
          - "policy_response"
          - "audit_event"
          - "state_update"
          - "consensus_vote"
          - "consensus_result"
          - "error"
          - "heartbeat"
      
      correlation_id:
        type: "string"
        description: "Links related messages (request/response pairs)"
      
      payload:
        type: "object"
        description: "Message-type-specific content"
      
      metadata:
        type: "object"
        properties:
          priority:
            type: "string"
            enum: ["low", "normal", "high", "critical"]
          ttl_ms:
            type: "integer"
            description: "Time to live in milliseconds"
          trace_id:
            type: "string"
            description: "Distributed tracing ID"

  example:
    message_id: "550e8400-e29b-41d4-a716-446655440000"
    timestamp: "2026-01-30T10:15:30.123Z"
    sender:
      agent_id: "finance-agent-001"
      agent_role: "finance-agent"
      session_id: "sess-abc123"
    message_type: "tool_request"
    correlation_id: "req-xyz789"
    payload:
      tool: "refund_user"
      args:
        user_id: "U12345"
        amount: 500
    metadata:
      priority: "normal"
      ttl_ms: 30000
      trace_id: "trace-def456"

# =============================================================================
# MESSAGE TYPES
# =============================================================================

message_types:

  tool_request:
    description: "Agent requests execution of a tool"
    payload_schema:
      type: "object"
      required: ["tool", "args"]
      properties:
        tool:
          type: "string"
          description: "Name of tool to execute"
        args:
          type: "object"
          description: "Arguments for the tool"
        context:
          type: "object"
          description: "Additional context for policy evaluation"
    
    flow: |
      Agent → Kernel(Policy Check) → Kernel(Tool Executor) → Agent
    
    example:
      tool: "send_email"
      args:
        to: "user@example.com"
        subject: "Your refund"
        body: "Your refund has been processed."

  tool_response:
    description: "Response from tool execution"
    payload_schema:
      type: "object"
      required: ["status", "audit_id"]
      properties:
        status:
          type: "string"
          enum: ["success", "blocked", "error"]
        result:
          type: "object"
          description: "Tool execution result (if success)"
        error:
          type: "object"
          properties:
            code:
              type: "string"
            message:
              type: "string"
            details:
              type: "object"
        policy_decision:
          type: "object"
          properties:
            decision:
              type: "string"
              enum: ["ALLOW", "DENY", "INADMISSIBLE"]
            reason:
              type: "string"
            matched_rule:
              type: "string"
        audit_id:
          type: "string"
          description: "Reference to audit log entry"
        execution_time_ms:
          type: "number"

  consensus_vote:
    description: "Agent submits vote in consensus process"
    payload_schema:
      type: "object"
      required: ["topic_id", "position", "votes_cast"]
      properties:
        topic_id:
          type: "string"
        position:
          type: "string"
          description: "The option being voted for"
        votes_cast:
          type: "integer"
          minimum: 1
          maximum: 10
        tokens_spent:
          type: "integer"
          description: "Quadratic cost of votes"
        evidence:
          type: "array"
          items:
            type: "object"
            properties:
              type:
                type: "string"
              content:
                type: "string"
        reasoning:
          type: "string"
        confidence:
          type: "number"
          minimum: 0
          maximum: 1
        blind_commit_hash:
          type: "string"
          description: "Hash of vote for blind commit phase"

  state_update:
    description: "Notification of state change"
    payload_schema:
      type: "object"
      required: ["state_type", "new_hash"]
      properties:
        state_type:
          type: "string"
          enum: ["working_memory", "episodic", "semantic", "full"]
        previous_hash:
          type: "string"
        new_hash:
          type: "string"
        delta:
          type: "object"
          description: "Summary of what changed"
        sequence:
          type: "integer"

  error:
    description: "Error notification"
    payload_schema:
      type: "object"
      required: ["error_code", "message"]
      properties:
        error_code:
          type: "string"
        message:
          type: "string"
        severity:
          type: "string"
          enum: ["warning", "error", "critical"]
        recoverable:
          type: "boolean"
        suggested_action:
          type: "string"
        stack_trace:
          type: "string"
          description: "Only in development mode"

# =============================================================================
# ROUTING RULES
# =============================================================================

routing:
  
  description: |
    All messages are routed through the kernel's message broker.
    The kernel applies policies and logs before forwarding.

  routes:
    tool_request:
      handler: "PolicyEnforcementAgent"
      then: "ToolExecutor (if allowed)"
      response_to: "sender"
    
    policy_query:
      handler: "PolicyEngine"
      response_to: "sender"
    
    consensus_vote:
      handler: "SwarmConsensusAgent"
      response_to: "all_participants"
    
    state_update:
      handler: "StateManager"
      response_to: "interested_parties"
    
    error:
      handler: "ErrorHandler"
      response_to: "sender + supervisors"

  broadcasting:
    description: "Some messages go to multiple recipients"
    rules:
      - type: "consensus_result"
        recipients: "all_topic_participants"
      - type: "state_update"
        recipients: "subscribed_agents"
      - type: "error (critical)"
        recipients: "all_supervisors"

# =============================================================================
# TRANSPORT LAYER
# =============================================================================

transport:
  
  internal:
    description: "Communication within same process"
    protocol: "in-memory channels"
    implementation: "tokio::sync::mpsc"
    features:
      - "Zero-copy where possible"
      - "Backpressure support"
      - "Bounded buffers"
  
  external:
    description: "Communication across processes/machines"
    options:
      - protocol: "gRPC"
        use_case: "Synchronous RPC calls"
        serialization: "Protocol Buffers"
      - protocol: "NATS"
        use_case: "Pub/sub messaging"
        serialization: "JSON"
      - protocol: "Redis Streams"
        use_case: "Persistent message queues"
        serialization: "JSON"
  
  security:
    authentication: "mTLS with client certificates"
    encryption: "TLS 1.3"
    message_signing: "Ed25519 (optional, for critical messages)"

# =============================================================================
# FLOW DIAGRAMS
# =============================================================================

flows:

  tool_execution:
    description: "Standard tool execution flow"
    diagram: |
      ┌─────────┐    tool_request    ┌─────────────────┐
      │  Agent  │ ─────────────────► │ Policy Enforce  │
      └─────────┘                    └────────┬────────┘
                                              │
                                   ┌──────────▼──────────┐
                                   │   Policy Decision   │
                                   │  ALLOW | DENY | NA  │
                                   └──────────┬──────────┘
                                              │
                    ┌─────────────────────────┼─────────────────────────┐
                    │ ALLOW                   │ DENY/INADMISSIBLE       │
                    ▼                         ▼                         │
            ┌───────────────┐         ┌───────────────┐                 │
            │ Tool Executor │         │ Return Error  │                 │
            │    (WASM)     │         │  + Reason     │                 │
            └───────┬───────┘         └───────────────┘                 │
                    │                                                   │
                    ▼                                                   │
            ┌───────────────┐                                           │
            │ Audit Logger  │◄──────────────────────────────────────────┘
            └───────┬───────┘
                    │
                    ▼
            ┌───────────────┐
            │ tool_response │
            │   to Agent    │
            └───────────────┘

  consensus_voting:
    description: "Multi-agent consensus flow"
    diagram: |
      ┌─────────────────────────────────────────────────────┐
      │                  VOTING INITIATED                    │
      │              (topic + options + deadline)            │
      └───────────────────────┬─────────────────────────────┘
                              │
                              ▼
      ┌─────────────────────────────────────────────────────┐
      │                 BLIND COMMIT PHASE                   │
      │    Agents submit hash(vote) - votes hidden           │
      └───────────────────────┬─────────────────────────────┘
                              │ (deadline reached)
                              ▼
      ┌─────────────────────────────────────────────────────┐
      │                   REVEAL PHASE                       │
      │    Agents reveal actual votes - verified vs hash     │
      └───────────────────────┬─────────────────────────────┘
                              │
                              ▼
      ┌─────────────────────────────────────────────────────┐
      │                  TALLY & DECIDE                      │
      │    Quadratic weighting applied - result determined   │
      └───────────────────────┬─────────────────────────────┘
                              │
                              ▼
      ┌─────────────────────────────────────────────────────┐
      │                consensus_result                      │
      │            broadcast to all participants             │
      └─────────────────────────────────────────────────────┘
